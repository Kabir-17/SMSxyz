name: Deploy to VPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Deploy to VPS
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        password: ${{ secrets.VPS_PASSWORD }}
        script: |
          export PATH=$PATH:/home/ubuntu/.nvm/versions/node/v24.11.1/bin
          # Auto-detect directory
          TARGET_DIR=""
          if [ -d "/var/www/SMS" ]; then
            TARGET_DIR="/var/www/SMS"
          elif [ -d "/var/www/SMS-main_2" ]; then
            TARGET_DIR="/var/www/SMS-main_2"
          elif [ -d "/var/www/sms" ]; then
            TARGET_DIR="/var/www/sms"
          elif [ -d "/var/www/SMSxyz" ]; then
            TARGET_DIR="/var/www/SMSxyz"
          elif [ -d "/var/www/html" ] && [ -d "/var/www/html/backend" ]; then
            TARGET_DIR="/var/www/html"
          fi

          if [ -z "$TARGET_DIR" ]; then
            echo "Error: Application directory not found in /var/www"
            ls -la /var/www
            exit 1
          fi

          echo "Found application in $TARGET_DIR"
          cd $TARGET_DIR
          
          # Pull latest changes
          echo "Pulling latest changes..."
          git pull origin main
          
          # Install Backend Dependencies & Restart
          echo "Installing Backend Dependencies..."
          cd backend
          npm install
          npm run build
          echo "Restarting Backend..."
          pm2 restart "sms-backend" || pm2 start dist/server.js --name "sms-backend"
          
          # Install Frontend Dependencies & Build
          echo "Building Frontend..."
          cd ../frontend
          npm install
          npm run build
          
          echo "Deployment Complete!"
